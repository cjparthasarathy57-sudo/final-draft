
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Offline Floor Plan Generator - Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:900px;margin:24px auto;padding:0 12px}
    input,button,textarea{width:100%;padding:10px;margin:8px 0;box-sizing:border-box}
    label{font-weight:600;margin-top:8px;display:block}
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    #preview{border:1px solid #ddd;padding:12px;min-height:240px}
  </style>
</head>
<body>
  <h1>Offline Floor Plan Generator (Local)</h1>
  <p>Upload a plot image and enter real-world plot width & height (meters) to get a scaled floor plan. No API keys required.</p>

  <label>Plot image (JPG/PNG)</label>
  <input type="file" id="file" accept="image/*" />

  <div class="row">
    <div class="col">
      <label>Plot width (meters)</label>
      <input id="plotWidth" placeholder="e.g., 10" />
    </div>
    <div class="col">
      <label>Plot height (meters)</label>
      <input id="plotHeight" placeholder="e.g., 8" />
    </div>
  </div>

  <label>Clusters (room segmentation) â€” try 3 or 4</label>
  <input id="kclusters" value="4" />

  <button id="generate">Generate Floor Plan</button>

  <div id="status"></div>
  <div id="preview">Preview will appear here.</div>

<script>
const API = (window.location.hostname === 'localhost') ? 'http://localhost:8000' : '';

document.getElementById('generate').addEventListener('click', async ()=>{
  const fileEl = document.getElementById('file');
  const w = parseFloat(document.getElementById('plotWidth').value);
  const h = parseFloat(document.getElementById('plotHeight').value);
  const k = parseInt(document.getElementById('kclusters').value) || 4;
  const status = document.getElementById('status');
  if (!fileEl.files.length){ status.innerText='Please choose a plot image.'; return; }
  if (!w || !h){ status.innerText='Please enter plot width and height in meters.'; return; }
  status.innerText = 'Uploading and processing...';
  const fd = new FormData();
  fd.append('file', fileEl.files[0]);
  fd.append('plot_width_m', w);
  fd.append('plot_height_m', h);
  fd.append('k_clusters', k);
  try{
    const resp = await fetch((API?API:'') + '/api/process', { method:'POST', body: fd });
    const j = await resp.json();
    if (!resp.ok){ status.innerText = 'Error: ' + (j.message || j.error || JSON.stringify(j)); console.error(j); return; }
    status.innerText = 'Done. Rendering preview and downloading DXF...';
    // render SVG preview
    if (j.layout){
      const layout = j.layout;
      const plotW = w, plotH = h;
      const svgW = 800, svgH = Math.round(svgW * (plotH/plotW));
      let svg = `<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${plotW} ${plotH}" xmlns="http://www.w3.org/2000/svg">`;
      svg += `<rect x="0" y="0" width="${plotW}" height="${plotH}" fill="#fff" stroke="#333" stroke-width="0.02"/>`;
      const scale = svgW/plotW;
      layout.forEach(r=>{
        const x = r.x_m, y = r.y_m, w = r.w_m, h = r.h_m;
        svg += `<g transform="translate(${x},${y})"><rect x="0" y="0" width="${w}" height="${h}" fill="none" stroke="#0077cc" stroke-width="0.02"/></g>`;
        svg += `<text x="${x+0.1}" y="${y+0.2}" font-size="0.2">${r.name} ${r.w_m}x${r.h_m}m</text>`;
      });
      svg += `</svg>`;
      document.getElementById('preview').innerHTML = svg;
    }
    // download DXF
    if (j.dxf_path){
      const dl = await fetch((API?API:'') + '/api/download?file=' + encodeURIComponent(j.dxf_path));
      const blob = await dl.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'floorplan.dxf'; a.click();
      URL.revokeObjectURL(url);
      status.innerText = 'DXF downloaded.';
    }
  }catch(err){
    status.innerText = 'Error: ' + err.message;
    console.error(err);
  }
});
</script>
</body>
</html>
